# E2E 테스트 시나리오 (방대한 버전)

> 목표: 모든 기능이 모든 경우의 수에서 의도한 대로 작동하는지 검증

---

## 테스트 환경 설정

```bash
# 1. Docker DB 시작
docker-compose up -d db

# 2. 백엔드 실행
cd backend
cp ../.env.example .env  # API 키 입력 필요
alembic upgrade head
uvicorn app.main:app --reload --port 8000

# 3. 프론트엔드 실행
cd frontend
npm run dev

# 4. Playwright 테스트 실행
npx playwright test
```

---

## 1. 인증 & 사용자 (Auth & Users)

### 1.1 회원가입
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| A001 | 유효한 이메일로 회원가입 | 인증 이메일 발송, 대기 상태 | - |
| A002 | 중복 이메일로 회원가입 시도 | 오류: "이미 사용중인 이메일" | - |
| A003 | 비밀번호 8자 미만으로 가입 시도 | 오류: 비밀번호 조건 불충족 | - |
| A004 | 이메일 인증 링크 클릭 | 이메일 인증 완료 | - |
| A005 | 만료된 인증 링크 클릭 | 오류: 링크 만료 | - |

### 1.2 로그인 & 토큰
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| A010 | 올바른 자격증명으로 로그인 | JWT 토큰 발급, 대시보드 이동 | member |
| A011 | 잘못된 비밀번호로 로그인 | 오류: "비밀번호가 일치하지 않습니다" | - |
| A012 | 미승인 계정으로 로그인 | 오류: "관리자 승인 대기중" | - |
| A013 | 비활성화 계정으로 로그인 | 오류: "비활성화된 계정" | - |
| A014 | Access Token 만료 후 자동 갱신 | Refresh Token으로 새 토큰 발급 | member |
| A015 | Refresh Token 만료 후 API 호출 | 로그인 페이지로 리다이렉트 | - |

### 1.3 역할별 접근 권한
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| A020 | viewer가 매수 요청 시도 | 차단: "보기 전용 사용자" | viewer |
| A021 | viewer가 토론 메시지 전송 시도 | 차단 | viewer |
| A022 | viewer가 포지션 목록 조회 | 허용 (읽기만) | viewer |
| A023 | member가 요청 제출 | 허용 | member |
| A024 | member가 다른 사람 요청 삭제 시도 | 차단 | member |
| A025 | manager가 요청 승인/거부 | 허용 | manager |
| A026 | manager가 팀 설정 변경 | 허용 | manager |
| A027 | admin이 사용자 승인 | 허용 | admin |
| A028 | admin이 역할 변경 | 허용 | admin |

### 1.4 팀원 관리
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| A030 | 팀장이 신규 가입자 승인 | 가입자 활성화, 로그인 가능 | manager |
| A031 | 팀장이 팀원 비활성화 | 해당 팀원 로그인 불가 | manager |
| A032 | 팀장이 팀원 역할 변경 (member→viewer) | 역할 변경됨 | manager |
| A033 | 팀장이 다른 사람에게 manager 위임 | 권한 이전 | manager |

---

## 2. 포지션 관리 (Positions)

### 2.1 포지션 생성 (요청 승인 통해)
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| P001 | 매수 요청 승인 → 포지션 자동 생성 | 포지션 생성, is_info_confirmed=false | manager |
| P002 | 포지션 생성 시 buy_plan 설정 | 분할 매수 계획 저장됨 | manager |
| P003 | 포지션 생성 시 TP/SL 목표 설정 | 익절/손절 목표 저장됨 | manager |

### 2.2 포지션 정보 확인 플로우
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| P010 | 미확인 포지션 목록에서 노란 느낌표 표시 | 아이콘 표시됨 | - |
| P011 | 팀장이 실제 체결가/수량 입력 | 정보 확인 완료, 아이콘 사라짐 | manager |
| P012 | 정보 확인 시 평균매입가 재계산 | 올바른 평균가 계산 | manager |

### 2.3 분할 매수/익절/손절 관리
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| P020 | 분할 매수 1차 완료 체크 | completed=true, 남은 횟수 감소 | manager |
| P021 | 익절 목표 1차 도달 체크 | completed=true, 부분 수량 반영 | manager |
| P022 | 손절 실행 | 해당 수량 차감, 손실 기록 | manager |
| P023 | 모든 매수 계획 완료 시 상태 변화 | "매수 완료" 표시 | - |

### 2.4 포지션 종료
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| P030 | 포지션 전량 청산 | status='closed', 손익 계산 | manager |
| P031 | 청산 시 실현손익 입력 | realized_profit_loss 저장 | manager |
| P032 | 청산 후 통계에 반영 | 수익률, 승률 업데이트 | - |
| P033 | 청산 시 미입력 필드 있으면 | 경고 표시 | manager |

### 2.5 포지션 삭제 (관리자 모드)
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| P040 | 관리자모드 OFF → 삭제 버튼 | 버튼 안 보임 | manager |
| P041 | 관리자모드 ON → 삭제 버튼 | 버튼 보임 | manager |
| P042 | 포지션 삭제 후 통계 | 해당 포지션 통계에서 제외 | manager |
| P043 | 포지션 삭제 후 연관 요청 | 요청도 함께 삭제됨 | manager |
| P044 | 포지션 삭제 후 연관 토론 | 토론도 함께 삭제됨 | manager |

---

## 3. 요청 & 승인 (Requests)

### 3.1 매수 요청
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| R001 | 팀원이 매수 요청 제출 | status='pending', 알림 발송 | member |
| R002 | 필수 필드 누락 시 제출 | 유효성 오류 | member |
| R003 | 같은 종목 중복 요청 | 허용 (별도 요청으로) | member |
| R004 | viewer가 매수 요청 시도 | 차단 | viewer |

### 3.2 매도 요청
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| R010 | 보유 포지션에 대해 매도 요청 | 정상 제출 | member |
| R011 | 보유 수량 초과 매도 요청 | 오류 또는 경고 | member |
| R012 | 매도 사유 입력 | sell_reason 저장됨 | member |

### 3.3 요청 승인/거부
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| R020 | 팀장이 매수 요청 승인 | 포지션 생성, 알림 발송 | manager |
| R021 | 팀장이 매도 요청 승인 | 포지션 수량 감소, 손익 기록 | manager |
| R022 | 팀장이 요청 거부 + 사유 입력 | 거부 사유 저장, 알림 발송 | manager |
| R023 | 이미 처리된 요청 재처리 시도 | 차단 | manager |

### 3.4 토론 개시
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| R030 | 팀장이 토론 개시 | Discussion 생성, 알림 발송 | manager |
| R031 | 팀원이 토론 요청 | 매니저에게 알림 | member |
| R032 | 토론중 요청 상태 변경 | status='discussion' | - |

### 3.5 요청 삭제 (관리자 모드)
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| R040 | 관리자모드 ON → 요청 삭제 | 연관 토론도 삭제 | manager |
| R041 | 삭제 후 포지션 영향 | 포지션은 유지 (이미 생성됐으면) | - |

---

## 4. 토론방 (Discussions)

### 4.1 실시간 채팅
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| D001 | 메시지 전송 | 실시간으로 상대방에게 표시 | member |
| D002 | 차트 공유 | chart_data 저장, 차트 렌더링 | member |
| D003 | 동시에 여러 사용자 채팅 | 모든 사용자에게 실시간 동기화 | - |
| D004 | viewer가 메시지 전송 시도 | 차단 | viewer |
| D005 | viewer가 채팅 읽기 | 허용 | viewer |

### 4.2 토론 종료/재개
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| D010 | 팀장이 토론 종료 + 요약 입력 | status='closed', summary 저장 | manager |
| D011 | 종료된 토론에 메시지 전송 시도 | 차단 | member |
| D012 | 팀장이 토론 재개 | status='open' | manager |
| D013 | 팀원이 재개 요청 | 매니저에게 알림 | member |

### 4.3 토론 내보내기
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| D020 | 토론 JSON 내보내기 | 전체 메시지 포함 | member |
| D021 | 세션별 TXT 내보내기 | 선택한 세션만 포함 | member |

### 4.4 토론/세션 삭제 (관리자 모드)
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| D030 | 토론 전체 삭제 | 모든 메시지 삭제 | manager |
| D031 | 특정 세션만 삭제 | 해당 기간 메시지만 삭제 | manager |

---

## 5. 알림 (Notifications)

### 5.1 알림 발송
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| N001 | 팀원 요청 제출 → 팀장 알림 | 실시간 알림 표시 | manager |
| N002 | 팀장 승인 → 팀원 알림 | 실시간 알림 표시 | member |
| N003 | 팀장 거부 → 팀원 알림 | 거부 사유 포함 알림 | member |
| N004 | 토론 개시 → 관련자 알림 | 토론방 링크 포함 | - |

### 5.2 알림 읽음 처리
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| N010 | 알림 클릭 | is_read=true, 해당 페이지 이동 | - |
| N011 | 전체 읽음 처리 | 모든 알림 is_read=true | - |
| N012 | 읽지 않은 알림 카운트 | 헤더에 뱃지 표시 | - |

---

## 6. 출석 (Attendance)

### 6.1 일일 출석
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| AT001 | 당일 첫 체크인 | status='present', 시간 기록 | member |
| AT002 | 당일 중복 체크인 시도 | "이미 체크인함" | member |
| AT003 | 자정 이후 체크인 | 새 날짜로 기록 (KST 기준) | member |

### 6.2 출석 회복
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| AT010 | 팀 칼럼 작성 → 이전 날짜 출석 회복 | 해당 날짜 status 변경 | member |
| AT011 | 이미 출석한 날짜 회복 시도 | 변화 없음 또는 오류 | member |

### 6.3 출석 통계
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| AT020 | 월별 출석률 조회 | 정확한 퍼센트 계산 | - |
| AT021 | 팀원별 출석률 비교 | 팀 통계 페이지에 표시 | - |

---

## 7. 통계 & 손익 계산 (Stats - 데이터 정합성 핵심)

### 7.1 수익률 계산
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| S001 | 포지션 1개 청산 후 수익률 | (실현손익/투자금)*100 정확 | - |
| S002 | 여러 포지션 평균 수익률 | 가중평균 또는 단순평균 정확 | - |
| S003 | 손실 포지션 포함 수익률 | 음수 값 정확히 표시 | - |

### 7.2 승률 계산
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| S010 | 3승 2패 → 승률 | 60% | - |
| S011 | 수익 0원 포지션 처리 | 승/패 기준 명확 | - |

### 7.3 자산 변화율
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| S020 | 초기자본 1억, 현재 1.1억 → 변화율 | +10% | - |
| S021 | 포지션 삭제 후 자산 변화율 | 해당 손익 제외하고 재계산 | - |
| S022 | 입금/출금 반영 (미래 기능) | 자본 변동 반영 | - |

### 7.4 팀 랭킹
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| S030 | 수익률 기준 팀원 랭킹 | 정확한 순위 | - |
| S031 | 동률 처리 | 공동 순위 표시 | - |

### 7.5 삭제 후 데이터 정합성
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| S040 | 포지션 삭제 → 전체 수익률 | 해당 포지션 제외 재계산 | manager |
| S041 | 포지션 삭제 → 자산 변화 그래프 | 해당 기록 제외 | manager |
| S042 | 요청 삭제 → 통계 영향 | 연관 데이터 정리 | manager |
| S043 | 사용자 비활성화 → 팀 통계 | 해당 사용자 제외 | admin |

---

## 8. 의사결정노트 & 보고서 (Decision Notes & Reports)

### 8.1 노트 CRUD
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| DN001 | 새 노트 작성 (블록 에디터) | blocks JSON 저장 | member |
| DN002 | 노트 수정 | 변경사항 저장 | member |
| DN003 | 노트 삭제 | DB에서 삭제 | manager |

### 8.2 AI 자동 생성
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| DN010 | AI 노트 생성 요청 | OpenAI API 호출, 노트 생성 | member |
| DN011 | OpenAI API 키 없을 때 | 적절한 오류 메시지 | - |
| DN012 | AI 일일 한도 초과 | "일일 한도 초과" 메시지 | - |

### 8.3 운용보고서
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| DN020 | AI 운용보고서 생성 | 기간별 실적 요약 | manager |
| DN021 | 보고서 내보내기 | PDF 또는 텍스트 | - |

---

## 9. 팀 칼럼 (Team Columns)

### 9.1 칼럼 CRUD
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| TC001 | 새 칼럼 작성 | blocks JSON 저장 | member |
| TC002 | 칼럼 수정 | 저장 | member |
| TC003 | 관리자모드 ON → 삭제 | 삭제됨 | manager |

### 9.2 칼럼 인증
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| TC010 | 팀장이 칼럼 인증 | is_verified=true | manager |
| TC011 | 인증된 칼럼 출석 회복 | 과거 출석 복구 | - |

---

## 10. 뉴스데스크 (NewsDesk)

### 10.1 뉴스 생성
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| ND001 | 오늘 뉴스데스크 생성 요청 | 크롤링 + AI 분석 시작 | manager |
| ND002 | 이미 생성된 날짜 재생성 시도 | "일일 1회 제한" 오류 | manager |
| ND003 | 네이버 API 키 없을 때 | 적절한 오류 | - |

### 10.2 뉴스 표시
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| ND010 | 키워드 트리맵 표시 | greed/fear 색상 정확 | - |
| ND011 | 탐욕/공포 지수 표시 | 0-100 범위, 게이지 정확 | - |
| ND012 | 뉴스 카드 클릭 → 사이드패널 | 상세 내용 표시 | - |
| ND013 | AI 칼럼 마크다운 렌더링 | 올바르게 표시 | - |

### 10.3 주목 종목
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| ND020 | 주목 종목 카드 표시 | 언급횟수, 등락률 표시 | - |
| ND021 | 종목 클릭 → 차트 | 해당 종목 차트 표시 | - |

---

## 11. 설정 (Settings)

### 11.1 테마
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| ST001 | 테마 변경 | 즉시 적용, localStorage 저장 | - |
| ST002 | 새로고침 후 테마 유지 | 저장된 테마 적용 | - |

### 11.2 관리자 모드
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| ST010 | 관리자모드 ON | 삭제 버튼 표시, 사이드바 인디케이터 | manager |
| ST011 | 관리자모드 OFF | 삭제 버튼 숨김 | manager |
| ST012 | member가 설정 페이지 → 관리자모드 | 섹션 안 보임 | member |

---

## 12. 시세 & 차트 (Prices & Charts)

### 12.1 시세 조회
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| PR001 | 한국 주식 시세 조회 | 현재가, 등락률 표시 | - |
| PR002 | 미국 주식 시세 조회 | Yahoo Finance 데이터 | - |
| PR003 | 암호화폐 시세 조회 | Binance 데이터 | - |
| PR004 | 잘못된 티커 검색 | "종목을 찾을 수 없음" | - |

### 12.2 차트
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| PR010 | 일봉 차트 표시 | 캔들 정확히 렌더링 | - |
| PR011 | 차트 기간 변경 | 데이터 업데이트 | - |
| PR012 | 차트 드래그/줌 | 인터랙션 정상 작동 | - |

---

## 13. 실시간 (WebSocket)

### 13.1 연결
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| WS001 | 로그인 후 WebSocket 연결 | 연결 성공 | - |
| WS002 | 토큰 만료 시 재연결 | 자동 재연결 | - |
| WS003 | 네트워크 끊김 후 복구 | 재연결 시도 | - |

### 13.2 실시간 이벤트
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| WS010 | 새 요청 → 팀장 실시간 알림 | 즉시 알림 표시 | manager |
| WS011 | 토론 메시지 → 참여자 실시간 | 즉시 메시지 표시 | - |
| WS012 | 가격 알림 트리거 | 실시간 알림 | - |

---

## 14. 팀 관리 (Team Management)

### 14.1 팀 설정
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| TM001 | 초기 자본금 설정 | KRW/USD 저장 | manager |
| TM002 | AI 일일 한도 설정 | 한도 저장 | manager |
| TM003 | 팀 설정 조회 | 올바른 값 표시 | - |

### 14.2 팀원 목록
| ID | 시나리오 | 예상 결과 | 역할 |
|----|----------|-----------|------|
| TM010 | 팀원 목록 조회 | 전체 팀원 표시 | manager |
| TM011 | 대기중 사용자 목록 | 미승인 사용자 표시 | manager |

---

## 테스트 우선순위

### P0: 크리티컬 (데이터 정합성)
- S040-S043: 삭제 후 데이터 정합성
- S001-S003: 수익률 계산
- S020-S021: 자산 변화율
- P030-P032: 포지션 종료 손익

### P1: 높음 (핵심 기능)
- A020-A028: 역할별 접근 권한
- R020-R023: 요청 승인/거부
- D001-D005: 실시간 채팅
- N001-N004: 알림 발송

### P2: 중간 (일반 기능)
- P001-P023: 포지션 관리
- R001-R012: 요청 제출
- AT001-AT021: 출석

### P3: 낮음 (부가 기능)
- ND001-ND021: 뉴스데스크
- DN001-DN021: 노트/보고서
- ST001-ST012: 설정

---

## 디버깅 루프

```
1. 테스트 실행 → 실패 발견
2. 오류 분석 (로그, 스크린샷)
3. 수정 (프론트: frontend-design 플러그인 필수!)
4. 재테스트
5. 통과 → 다음 테스트
```

---

## 병렬 테스트 설정

Playwright에서 두 브라우저 동시 실행:

```javascript
// 팀장 브라우저
const managerContext = await browser.newContext();
const managerPage = await managerContext.newPage();

// 팀원 브라우저
const memberContext = await browser.newContext();
const memberPage = await memberContext.newPage();

// 상호작용 테스트
await memberPage.click('button:text("매수 요청")');
await expect(managerPage.locator('.notification-badge')).toBeVisible();
```
