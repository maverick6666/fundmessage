# 미래 기능 계획

> 이 문서는 나중에 구현할 기능들을 체계적으로 정리한 것입니다.
> "그때 말했던 거 하고 싶다"고 하면 이 문서를 참조하세요.

---

## B. 세션/기수 관리 (Fund Generation Management)

### 배경
펀드팀은 무한히 굴러가는 게 아니라 **기수 단위**로 운영됨 (예: 32기 → 33기)

### 필요한 기능

#### 1. 기수(세션) 모델
```
FundSession:
  - id
  - generation_number (32, 33, ...)
  - start_date
  - end_date (nullable - 진행중이면 null)
  - initial_capital_krw
  - initial_capital_usd
  - status (active, closed, transitioning)
```

#### 2. 승계 프로세스
1. 32기 팀장이 33기 인원들의 회원가입 승인
2. 33기 인원들은 처음에 `member` 역할
3. 32기 팀장이 33기 중 한 명에게 `manager` 역할 위임
4. 32기 팀장 본인은 `viewer` (전관예우) 또는 `admin`으로 변경
5. 승계 완료 시점에 자본금 재계산

#### 3. 자본 변동 기록
```
CapitalTransaction:
  - id
  - session_id
  - transaction_type (deposit, withdrawal, loan, investment, ...)
  - amount
  - currency (KRW, USD)
  - description
  - executed_by (user_id)
  - executed_at
```

#### 4. 전관예우
- 이전 기수 멤버들을 `viewer` 권한으로 변경
- 과거 데이터는 볼 수 있지만 수정/삭제 불가
- 현재 기수의 데이터도 읽기만 가능

#### 5. 승계 중 상태
- 32기와 33기가 동시에 존재하는 과도기
- `transitioning` 상태에서는 특정 작업 제한 가능
- 승계 완료 버튼으로 마무리

### 고려사항
- 승계 중 포지션은 어떻게? (자동 청산? 승계?)
- 과거 기수의 통계는 별도 조회 가능해야 함
- 기수별 리더보드/랭킹

---

## C. 멀티테넌시 (Multi-tenancy)

### 배경
이 펀드팀 메신저를 다른 대학 펀드팀도 사용할 수 있게 하려면?

### 필요한 기능

#### 1. 팀(테넌트) 모델
```
Team:
  - id
  - code (고유 코드, 예: "SNU_FUND", "YONSEI_INVEST")
  - name ("서울대 펀드팀", "연세대 투자동아리")
  - created_at
  - is_active
  - created_by (최초 등록한 super admin)
```

#### 2. 사용자-팀 연결
```
User 테이블에 추가:
  - team_id (FK to Team)
```

#### 3. 대학 코드 발급 방식

**옵션 A: 관리자가 직접 발급**
1. 계약 체결 후 super admin이 Team 레코드 생성
2. 해당 팀의 첫 팀장에게 초대 코드 발급
3. 첫 팀장이 초대 코드로 회원가입 → 자동으로 manager 역할

**옵션 B: 셀프 서비스**
1. 회원가입 시 "새 팀 생성" 옵션
2. 팀 생성자가 자동으로 manager
3. 팀 코드는 자동 생성 또는 직접 입력

**추천: 옵션 A** (계약 기반이므로 관리자 승인 필요)

#### 4. 데이터 격리
- 모든 쿼리에 `team_id` 필터 추가
- Position, Request, Discussion 등 모든 테이블에 team_id 추가
- API에서 current_user.team_id로 자동 필터링

#### 5. Super Admin 역할
```
UserRole에 추가:
  - SUPER_ADMIN (모든 팀 관리 가능)
```

### 고려사항
- 팀 간 데이터는 완전히 격리
- 팀별 설정 (TeamSettings)은 이미 있음 - team_id 연결 필요
- 팀별 요금제? (무료/유료 tier)

---

## D. 뉴스데스크 공유 캐시 (NewsDesk Shared Cache)

### 배경
멀티테넌시(C) 도입 시, 각 팀이 같은 날짜의 뉴스데스크를 각각 생성하면 **동일한 AI 분석을 중복 호출**하게 됨. 뉴스데스크의 원본 뉴스와 AI 분석 결과는 팀에 관계없이 동일하므로, 한 번 생성된 결과를 공유하면 API 비용을 대폭 절감할 수 있음.

### 핵심 아이디어
1. 팀 A가 2월 10일 뉴스데스크를 생성 요청 → AI 분석 실행 → **메인 DB에 저장**
2. 팀 B가 같은 2월 10일 뉴스데스크를 요청 → **이미 존재하므로 AI 호출 없이 즉시 반환**
3. 팀 B의 AI 일일 사용량은 차감되지만, 실제 API 호출은 발생하지 않음 (또는 할인 적용)

### 추가 이점: 과거 뉴스데스크 열람
- 현재는 7일 이내만 생성 가능 (네이버 뉴스 크롤링 한계)
- 공유 캐시 도입 시, **이미 다른 팀이 생성해둔 과거 뉴스데스크**는 7일 이전이라도 열람 가능
- 크롤링 불가 → AI 생성 불가이지만, 이미 존재하는 데이터는 제공 가능
- UX 개선: "생성 불가" 대신 "과거 뉴스데스크 보기" 제공

### 구현 방향

#### 1. NewsDesk 테이블 분리
```
SharedNewsDesk (공유 - 팀 무관):
  - id
  - publish_date (UNIQUE)
  - columns, news_cards, keywords, sentiment, top_stocks
  - raw_news_count
  - created_at
  - created_by_team_id (최초 생성한 팀)

TeamNewsDeskAccess (팀별 접근 기록):
  - id
  - team_id
  - shared_newsdesk_id (FK)
  - accessed_at
  - was_cached (boolean - AI 호출 여부)
```

#### 2. 생성 요청 플로우
```
팀에서 뉴스데스크 생성 요청
  → SharedNewsDesk에 해당 날짜 존재?
    → YES: 캐시 히트! 즉시 반환 + TeamNewsDeskAccess 기록
    → NO: 7일 이내?
      → YES: 크롤링 + AI 생성 + SharedNewsDesk 저장
      → NO: "해당 날짜의 뉴스데스크가 존재하지 않습니다"
```

#### 3. 비용 모델
- **직접 생성**: AI API 비용 전액 차감
- **캐시 히트**: 무료 또는 소액 (DB 조회 비용만)
- 팀별 월간 리포트에 "캐시 절감액" 표시 가능

#### 4. 구독 모델 & 뉴스데스크 활성화

**팀 상태 3단계:**
```
미구독 (기본)     → 뉴스데스크 기능 비활성. 메뉴 보이지 않거나 "구독 필요" 안내.
구독 활성화       → 매일 자동 갱신 ON (스케줄러가 해당 팀에도 적용).
                    단, 실제 AI 생성은 1회만 (원본 팀의 SharedNewsDesk 사용).
```

**구독 시 동작:**
- 구독 활성화 = 팀의 `newsdesk_enabled` 플래그 0 → 1
- 매일 KST 05:30 스케줄러가 SharedNewsDesk 기준으로 해당 팀에도 오늘 뉴스데스크 열람 권한 부여
- 사용자는 매일 자동으로 오늘의 뉴스데스크를 볼 수 있음

**데이터 모델 추가:**
```
TeamNewsDeskSubscription:
  - team_id (FK)
  - is_active (boolean)
  - plan_type (free, basic, premium)
  - daily_past_request_limit (하루 과거 열람 횟수)
  - activated_at
  - expires_at (nullable)
```

#### 5. 과거 뉴스데스크 AI 생성 요청 (= 열람 권한 부여)

**핵심 개념**: 과거 날짜의 뉴스데스크는 이미 SharedNewsDesk에 존재함.
사용자가 "AI 생성 요청"을 하면, 실제로는 해당 날짜의 **열람 권한을 활성화**하는 것.

**플로우:**
```
사용자가 과거 날짜 선택 (달력 이동 범위: SharedNewsDesk에 존재하는 날짜만)
  → 해당 날짜 TeamNewsDeskAccess에 팀 기록 없음
  → "뉴스데스크 생성하기" 버튼 표시
  → 클릭 → AI 생성 로딩 UI 연출 (프로그레스 바 0% → 100%)
  → 실제 백엔드: SharedNewsDesk에서 조회 + TeamNewsDeskAccess 기록 생성
  → 로딩 완료 → 뉴스데스크 표시
  → 이후 해당 날짜는 재요청 없이 즉시 열람 가능
```

**하루 3회 제한:**
- 과거 뉴스데스크 "AI 생성 요청"은 하루 3회까지 (plan_type에 따라 변동)
- 사용자 눈에는 AI가 분석하는 것처럼 보이지만, 실제 AI 비용 = 0
- 횟수 제한이 수익화 포인트 (더 많이 보려면 상위 플랜)

**이 로직은 모든 팀에 공통 적용** (원본 팀 포함).
단, 원본 팀은 스케줄러가 매일 자동 생성 → 모든 날짜에 접근 기록 존재 → 이 플로우를 볼 일 없음.

#### 6. 수익화: 플랜 구조

| 플랜 | 매일 자동 갱신 | 과거 열람 | 가격 |
|------|-------------|---------|------|
| 미구독 | X | X | 무료 |
| Basic | O | 하루 3회 | 월 N원 |
| Premium | O | 무제한 | 월 N원 |

- SharedNewsDesk 데이터가 축적될수록 과거 열람의 가치 증가
- 실제 AI 비용은 원본 팀 1회 생성분만 발생 → 높은 마진
- 팀별 월간 리포트에 "AI 분석 횟수" / "열람 기록" 표시

### 고려사항
- 뉴스데스크 내용은 팀 공통이므로 공유에 문제 없음
- 팀별 커스텀 뉴스데스크 (특정 섹터 집중 등)는 별도 기능으로 분리
- 최초 생성팀에 "기여 배지" 같은 인센티브 부여 가능
- 캐시 적중률이 높아질수록 전체 운영비 절감
- 수동 생성 엔드포인트는 이미 제거됨 (2026-02-10) → 스케줄러만 실제 AI 생성

### 관련 의존성
- C. 멀티테넌시 구현 후 적용 가능
- 현재 단일 팀 환경에서는 불필요

---

## 구현 순서 제안

1. **B. 세션/기수 관리** 먼저
   - 현재 사용 중인 팀에 바로 필요한 기능
   - 멀티테넌시 없이도 작동 가능

2. **C. 멀티테넌시** 나중에
   - B가 완성된 후 team_id 컬럼 추가
   - 기존 데이터는 default team으로 마이그레이션

3. **D. 뉴스데스크 공유 캐시** - C 이후
   - 멀티테넌시 기반 위에 구축
   - 팀 수가 늘어날수록 비용 절감 효과 극대화

---

## 관련 날짜
- 최초 논의: 2026-02-08
- D항 추가: 2026-02-10
- D.4 구독 모델 + D.5 과거 열람 요청 + D.6 플랜 구조 추가: 2026-02-10
- 수동 생성 제거 결정: 2026-02-10
- 상태: 계획 단계 (미구현)
