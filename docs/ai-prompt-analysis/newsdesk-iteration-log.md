# 뉴스데스크 프롬프트 Iteration Log

> 뉴스데스크 AI 품질 개선 시행착오 기록. 각 Iteration마다 변경-결과-교훈을 기록.
> 모델: gpt-5-mini (Responses API)

## 요약 테이블

| Iter | 날짜 | API | verbosity | 주요 변경 | 칼럼 avg | 카드 avg | 종목 avg | 핵심 발견 |
|------|------|-----|-----------|----------|---------|---------|---------|----------|
| 0 | 2026-02-10 | Chat Completions | - | 기준선 | 1,342 (64%) | 589 (71%) | 700 (82%) | 길이 미달 전반적 |
| 1 | 2026-02-10 | Chat Completions | - | XML+밀도+오버슈트 | 1,558 (74%) | 638 (77%) | 584 (69%) | 종목 퇴행 -16% |
| 2 | 2026-02-12 | Responses | high | verbosity 적용 | 1,667 (79%) | 680 (82%) | 711 (84%) | 퇴행 회복, JSON 후처리 |
| 3 | TBD | Responses | high | 프롬프트 5대 수정 | TBD | TBD | TBD | TBD |

> 달성률 기준: 칼럼 ~2,100자, 카드 ~825자, 종목 ~850자 (클로드 코드 이상적 결과물)

---

## Iter 0: 기준선 (Chat Completions, 기본 프롬프트)

### 변경 사항
- 없음 (gpt-5-mini 최초 테스트)

### API 설정
- Chat Completions + response_format=json_object

### 프롬프트 요약
- 시스템 프롬프트 ~2,000자 (역할 + 출력 규칙 + 각 항목 스펙)
- 뉴스카드 800자+, 칼럼 2,000자+, 종목 800자+ 최소 요구

### 결과

칼럼:
- 국내: "오천피 시대—빚투·시총 급증의 역설" — 1,446자
- 해외: "다우 5만·AI 충격, 美증시의 분기점?" — 1,237자
- 평균: 1,342자 (64%)

뉴스카드 6개:
- #1 [국내] "초단기 빚투 1년6개월 만에 최고" — 657자
- #2 [국내] "K-증시 시가총액 세계 8위 도약" — 603자
- #3 [국내] "은행권 '모임통장' 경쟁 심화" — 623자
- #4 [해외] "다우 5만 돌파—美 증시의 함의" — 589자
- #5 [해외] "AI 충격에 소프트웨어 '가치 재평가' 진행" — 519자
- #6 [해외] "비트코인·가상자산, '테크 렉'에 흔들" — 544자
- 국내 avg: 628자 / 해외 avg: 551자
- 전체 평균: 589자 (71%)

주목종목 3개:
- #1 삼성전자 — 756자
- #2 SK하이닉스 — 686자
- #3 네이버 — 657자
- 평균: 700자 (82%)

### 교훈
- gpt-5-nano 대비 구조 문제(3컬럼 테이블, 카드 0개) 모두 해결
- 길이 미달 (64~82%): "N자 이상" 위협적 표현이 GPT-5에서 비효과적
- JSON 키 불일치 발견: stock_name vs name

---

## Iter 1: XML + 구조적 밀도 + 오버슈트

### 변경 사항
1. XML 태그 구조화: `<ROLE>`, `<OUTPUT_RULES>`, `<NEWS_CARD_SPEC>`, `<COLUMN_SPEC>`, `<TOP_STOCKS_SPEC>`, `<SENTIMENT_SPEC>`, `<QUALITY_CHECKLIST>`
2. 역할 심화: "대형 증권사 리서치센터 수석 편집자" + "독자는 펀드매니저와 트레이더"
3. 구조적 밀도: 카드/칼럼/종목 각각 4파트 소제목, 교차참조 3-4개, 볼드 수치 필수
4. 오버슈트 타겟: 카드 800→1,200-1,500, 칼럼 2,000→2,500-3,000, 종목 800→1,000-1,200
5. "간결함" 제거 → "완성도 우선" (뉴스데스크에는 실제로 안 들어감)
6. QUALITY_CHECKLIST 셀프 검증 추가

### API 설정
- Chat Completions + response_format=json_object (변경 없음)
- verbosity 사용 불가 (response_format과 충돌)

### 프롬프트 diff 요약
- 시스템 프롬프트 ~2,000자 → ~4,400자 (2.2x 증가)
- XML 태그로 전체 래핑
- 각 SPEC에 파트별 분량 명세 추가

### 결과

칼럼:
- 국내: "코스피 5천 돌파, 거품일까 지속일까?" — 1,730자
- 해외: "다우 5만 돌파, AI 쇼크가 남긴 과제들" — 1,385자
- 평균: 1,558자 (74%)

뉴스카드 6개:
- #1 [국내] "초단기 빚투 사상 최고치 경신" — 722자
- #2 [국내] "한국 증시 시총 세계 8위 진입" — 712자
- #3 [국내] "삼전·SK하닉 호실적이 남긴 과제" — 604자
- #4 [해외] "다우 5만 시대와 반도체 랠리" — 606자
- #5 [해외] "비트코인·가상자산, 테크 렉의 충격" — 598자
- #6 [해외] "글로벌 랠리 속 순환매와 경고등" — 588자
- 국내 avg: 679자 / 해외 avg: 597자
- 전체 평균: 638자 (77%)

주목종목 3개:
- #1 삼성전자 — 685자
- #2 SK하이닉스 — 536자
- #3 네이버 — 532자
- 평균: 584자 (69%)

### 교훈
- XML 구조화 + 구조적 밀도: 칼럼 +16%, 카드 +8%로 중간 효과
- 오버슈트 역효과: 종목 -16% 퇴행 — 1.5x 이상은 모델이 "비현실적"으로 무시하거나 다른 항목에 토큰 재배분
- 단일 JSON 출력의 토큰 트레이드오프: 칼럼/카드 증가 → 종목 감소
- 프롬프트만으로는 최대 +16% (verbosity 없이)

---

## Iter 2: Responses API + verbosity=high (JSON 후처리)

### 변경 사항
1. response_format=json_object 제거 → 텍스트 출력
2. Responses API + verbosity=high 적용
3. _extract_json() 3단계 파싱 추가 (직접 파싱 → 코드블록 추출 → { } 경계 추출)
4. 프롬프트 끝에 "JSON만 출력하세요." 지시 추가

### API 설정
- Responses API + text={"verbosity": "high"}
- fallback: Chat Completions + response_format=json_object

### 코드 변경
```python
# newsdesk_ai.py generate_newsdesk()
# 1차: Responses API + verbosity
response = self.client.responses.create(
    model=settings.openai_model,
    instructions=system_prompt,
    input=prompt,
    text={"verbosity": settings.openai_verbosity},
)
raw_text = response.output_text
result = self._extract_json(raw_text)  # 텍스트에서 JSON 추출
```

### 결과

칼럼:
- 국내: "한국 증시, 실물·정책 리스크의 교차로" — 1,846자
- 해외: "미국 증시, 금리·에너지·AI 갈림길" — 1,488자
- 평균: 1,667자 (79%)

뉴스카드 6개:
- #1 [국내] "대치·쌍용, 1324세대 재건축 통합" — 902자
- #2 [국내] "반포미도2차, 최고46층·559세대 재건축" — 590자
- #3 [국내] "삼성바이오로직스, PCF 검증 완료" — 668자
- #4 [해외] "사상 최장 中 춘제에 韓·中 특수 기대" — 641자
- #5 [해외] "LG전자, 아부다비서 이노페스트 개막" — 608자
- #6 [해외] "Bitwise CIO, 다음 암호장세 9대 요인 제시" — 670자
- 국내 avg: 720자 / 해외 avg: 640자
- 전체 평균: 680자 (82%)

주목종목 3개:
- #1 삼성바이오로직스 — 803자
- #2 삼성전자 — 724자
- #3 CJ제일제당 — 607자
- 평균: 711자 (84%)

### 교훈
- verbosity=high가 뉴스데스크에서도 효과적 (특히 종목 +22%)
- response_format 없이도 JSON 파싱 100% 성공 (3단계 추출)
- 의사결정서/운용보고서(+46~72%)에 비해 효과 작음 (+6~22%) — 단일 호출에 11개 항목 생성하므로 토큰 분산
- 종목 퇴행(Iter 1) 완전 회복

---

## Iter 3: 프롬프트 5대 문제 수정 (예정)

### 식별된 문제
1. OUTPUT_RULES에 "완성도 우선" 시그널 없음
2. 오버슈트 과잉: 카드 1,200-1,500(달성 45%), 칼럼 2,500-3,000(달성 56%), 종목 1,000-1,200(달성 59%)
3. 뉴스 입력 50개 → 입력 토큰 과다 소비
4. QUALITY_CHECKLIST에 분량 검증 없음
5. REQUIREMENTS와 SPEC 간 중복 (토큰 낭비)

### 변경 사항
(구현 후 채움)

### 결과
(테스트 후 채움)

### 교훈
(분석 후 채움)

---

## Iteration 템플릿

```
## Iter N: [제목]

### 변경 사항
1. ...

### API 설정
- ...

### 결과
| 항목 | 이전 Iter | 현재 | 변화 |
|------|----------|------|------|
| 칼럼 avg | | | |
| 카드 avg | | | |
| 종목 avg | | | |

### 교훈
- ...
```
