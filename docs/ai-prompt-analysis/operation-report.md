# AI 운용보고서 프롬프트 분석

## 테스트 환경
- 모델: gpt-5-nano
- 데이터: SK하이닉스 포지션 (position_id=4)
  - 평균매수가 839,000원, 3주, 토론 3세션 32메시지, 의사결정서 3개
  - 매수요청 1건 (승인), 매매계획: 매수 1건(완료), 익절 1건(대기)

## 코드 수정

### collect_position_data() 개선
- 메시지에 message_type 필드 추가 (text/chart/system)
- 시스템 메시지 type="system"으로 구분
- 차트 데이터: chart_summary (candle_count, first_5, last_5)
- discussion별 message_count 추가

### 데이터 전처리 (Phase 2 핵심 개선)
- `to_kst_str()`: UTC → KST 변환 후 "YYYY-MM-DD HH:MM" 문자열
- `fmt_price()`: Decimal → "839,000원" 콤마 포맷
- `holding_period`: opened_at ~ now/closed_at 계산 → "1일 6시간"
- position.status: "open" → "진행중"
- position.is_info_confirmed: bool → "확인됨/미확인"
- request.type: "buy" → "매수", status: "approved" → "승인"

### 결론: 데이터 전처리가 프롬프트보다 효과적
gpt-5-nano는 "UTC를 KST로 변환하라"는 지시를 못 따르지만,
이미 "2026-02-08 23:47"로 전처리된 값은 그대로 출력할 수 있음.
**AI에게 변환/계산을 시키지 말고, 전처리된 데이터를 제공하는 것이 핵심.**

## 프롬프트 반복 개선

### Iteration 0 (원본 프롬프트)
- 구조: 7섹션 (개요/매매/계획/요청/의사결정/토론/종합평가)
- 장점: 기본 구조 양호, 의사결정 요약 양호
- 단점:
  - 메타 설명 다수 ("비고:", "주의:", "요약 설명:", "필요하신 경우...")
  - 매매계획/요청 이력에 테이블 미사용 (불렛 리스트)
  - 현재 평가 섹션 누락
  - UTC 시간 그대로 표시
  - 보유기간 "기록 없음"
  - 가격 콤마 미표기 (839000.0)
  - 종합 평가 3하위항목 미준수

### Iteration 1 (프롬프트 강화)
**시스템 프롬프트 변경:**
- "절대 금지" 섹션 추가: 구체적 메타 설명 예시 나열
- "날짜는 UTC → KST" 원칙 추가
- "출력 형식 준수" 원칙 추가

**사용자 프롬프트 변경:**
- 포지션 개요에 보유기간, 정보확인 행 추가
- 현재 평가 섹션 추가
- 매매계획 4컬럼 테이블 형식 제시
- 요청 이력 7컬럼 테이블 형식 제시
- 토론 세션별 구분 형식 상세화
- 종합 평가 3항목 명시

**결과:**
- 코드 변경이 `restart`로 반영되지 않아 이전과 동일한 결과
- (Docker `up --build` 필요했음)

### Iteration 2 (데이터 전처리 + 프롬프트)
**백엔드 코드 변경:**
- `to_kst_str()`, `fmt_price()` 함수로 데이터 전처리
- 보유기간 자동 계산
- 상태값 한글 변환

**결과 (대폭 개선):**
- ✅ 진입일 KST 표시 (단, +9시간 중복 적용 → "날짜 그대로 사용" 지시로 수정)
- ✅ 보유기간 "1일 6시간" 표시
- ✅ 가격 콤마 표기 (839,000원)
- ✅ 정보 확인 "미확인" 표시
- ✅ 현재 평가 섹션 포함
- ✅ 매매계획 4컬럼 테이블 준수
- ✅ 요청 이력 7컬럼 테이블 준수
- ✅ 의사결정 기록 번호 형식 (노트 1~4)
- ✅ 토론 세션별 완벽 분리 (제목/참여/메시지/핵심/합의)
- ✅ 종합 평가 3항목 구분 (투자 근거/계획 대비/리스크)
- ✅ 메타 설명 대폭 감소

## gpt-5-nano 모델 한계 (운용보고서)

| 항목 | Iter 0 | Iter 2 | 비고 |
|------|--------|--------|------|
| 7섹션 구조 | O | O | 모든 반복에서 준수 |
| 테이블 형식 | X | O | 데이터 전처리 + 명확한 예시로 해결 |
| 현재 평가 섹션 | X | O | 프롬프트에 명시 후 준수 |
| 메타 설명 금지 | X | △ | 대폭 감소했으나 완전 제거는 안됨 |
| 세션별 토론 분리 | O | O | 의사결정서보다 잘 지킴 |
| 종합 평가 3항목 | X | O | 프롬프트 명시 후 준수 |
| 날짜/가격 포맷 | X | O | 전처리 데이터로 해결 |
| 보유기간 계산 | X | O | 백엔드에서 계산 후 전달 |
| 데이터 무결성 | O | O | 토론 내용 기반으로 작성 |

## 최종 프롬프트
- 파일: `backend/app/services/ai_service.py`
- 시스템 프롬프트: 절대금지 + 7개 원칙
- 사용자 프롬프트: 7섹션 + 데이터 전처리
- 핵심 교훈: AI에게 변환을 시키지 말고, 전처리된 데이터를 제공하라

## 프로덕션 모델(gpt-5-mini) 전환 시 기대 효과
- 메타 설명 완전 제거 예상
- 종합 평가 서술 품질 향상 예상
- 전반적 문장 품질 개선 예상
