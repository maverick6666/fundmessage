# AI 의사결정서 프롬프트 분석

## 테스트 환경
- 모델: gpt-5-nano
- 데이터: SK하이닉스 토론 32개 메시지 (3세션, 3명 참여, 차트 1회 공유)
- 포지션: position_id=4, 평균매수가 839,000원, 3주

## 코드 수정 (Phase 1-1)

### get_session_messages() 개선
- 시스템 메시지 `[시스템]` 태그로 구분
- KST HH:MM 시간 표시 추가
- chart 메시지: OHLCV 데이터 JSON 포함
- 세션 제목/의제 헤더에 포함

### generate_decision_note() 개선
- position_context 확장: buy_plan, tp_targets, sl_targets JSON 추가
- 요청 이력(Request) 시간순 추가
- total_buy_amount 필드 추가

## 프롬프트 반복 개선

### Iteration 0 (원본 프롬프트)
- 구조: 6섹션 (개요/참여자/논의/결정/리스크/후속)
- 장점: 기본 구조 양호, 참여자 의견 정리
- 단점: 3세션 구분 없이 통합, 차트 데이터 미활용, 결론이 길고 정리 안됨

### Iteration 1 (개선 v1)
**시스템 프롬프트 변경:**
- "차트 분석 활용" 원칙 추가
- "다중 세션 통합" 원칙 추가
- "데이터 무결성" 원칙 추가

**사용자 프롬프트 변경:**
- 개요 테이블: "토론 기간" 행 추가
- 최종 결정 테이블: "진입 전략" 행 추가
- 논의 흐름: 세션별 구분 형식 제시
- 리스크 테이블: "대응 방안" 컬럼 추가

**결과:**
- 참여자 의견이 근거를 하위 리스트로 구조화 (개선)
- 결론에 구체적 수치 포함 (개선)
- 문제: "참고: 차트는 첨부 자료로 확인합니다" 메타 설명 삽입

### Iteration 2 (개선 v2)
**시스템 프롬프트 변경:**
- "절대 금지" 원칙 강화 (참고, 본 문서는 등 명시)
- "출력 형식 준수" 원칙 추가
- 차트 데이터 관련: "별도 '참고' 문구 불필요" 명시

**사용자 프롬프트 변경:**
- 논의 흐름 세션별 형식 더 명확하게

**결과:**
- 결론이 1차/2차 매수, TP1/TP2/SL 구조적으로 정리 (개선)
- 리스크 4개로 세분화 (섹터 집중도, 업황/공급, 시장 변동성, 차익실현) (개선)
- 후속 조치 5개로 구체적 (개선)
- 문제: 여전히 blockquote 메타 설명, 세션별 구분 미준수, 3컬럼 테이블 미준수

## gpt-5-nano 모델 한계

| 항목 | 준수 여부 | 비고 |
|------|----------|------|
| 6섹션 구조 | O | 모든 반복에서 준수 |
| 테이블 헤더/구분선 | O | 잘 지킴 |
| 참여자별 의견 구분 | O | 하위 리스트까지 잘 구조화 |
| 메타 설명 금지 | X | "참고:" 문구 반복적으로 삽입 |
| 세션별 논의 흐름 | X | 단일 문단으로 통합 |
| 3컬럼 리스크 테이블 | X | 2컬럼만 생성 |
| 제목 15자 이내 | O | 잘 지킴 |
| 데이터 무결성 | O | 토론 내용 기반으로 작성 |

## 최종 프롬프트
- 파일: `backend/app/services/ai_service.py` (246-310행)
- 시스템 프롬프트: 8개 원칙
- 사용자 프롬프트: 6섹션 + 진입전략/토론기간/대응 컬럼

## 프로덕션 모델(gpt-5-mini) 전환 시 기대 효과
- 메타 설명 금지 규칙 더 잘 준수할 것으로 예상
- 세션별 논의 흐름 구분 가능할 것으로 예상
- 3컬럼 테이블 생성 가능할 것으로 예상
